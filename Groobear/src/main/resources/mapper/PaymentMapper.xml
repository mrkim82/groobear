<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.groo.bear.payment.mapper.PaymentMapper">
	<!-- 결재자 리스트, 정보 -->
	<select id="payEmpList" resultType="EmpVO">
		SELECT * FROM users u, user_info i, departments d
		WHERE u.emp_no = i.emp_no 
		AND i.dept_no = d.dept_no
	</select>
	<!-- 기안자 정보 Id,emp_no,name,rank,dept_name -->
	<select id="payEmpInfo" resultType="EmpVO">
		SELECT u.id,u.emp_no,i.name,i.rank,d.dept_name FROM users u, user_info i, departments d
			WHERE i.dept_no = d.dept_no
			AND u.emp_no = i.emp_no
			AND u.emp_no = (SELECT emp_no 
								FROM users
								WHERE id = #{id})
	</select>
	<!-- 문서번호 받아오는 쿼리문 -->
	<select id="paymentNo" resultType="int">
		SELECT NVL(MAX(pay_no),0)+1 as pay_no FROM payment
	</select>
	<!-- 결재문서 insert -->
	<insert id="paymentLogBook" parameterType="PaymentVO">
		INSERT INTO payment(pay_no,issue_date,doc_type,id,approver2,approver3,referrer,pay_status1,public_sign) 
						VALUES(
								#{payNo},
								sysdate,
								#{docType},
								#{id},
								#{approver2},
								<choose>
								<when test="approver2 != null and !approver2.equals('')">
								#{approver3},
								</when>
								<otherwise>
								'',
								</otherwise>
								</choose>
								<choose>
								<when test="referrer != null and !referrer.equals('')">
								#{referrer},
								</when>
								<otherwise>
								'',
								</otherwise>
								</choose>
								'Y',
								<choose>
								<when test="publicSign != null and !publicSign.equals('')">
								#{publicSign}
								</when>
								<otherwise>
								''
								</otherwise>
								</choose>
								)
	</insert>
	<!-- 결재문서 운행일지 삽입 -->
	<insert id="logDataInsert" parameterType="PaymentVO">
		INSERT INTO payment_logbook(oper_date,destination,befored,afterd,imprest,purpose,pay_no)
					VALUES(
							#{operDate},
							#{destination},
							#{befored},
							#{afterd},
							#{imprest},
							#{purpose},
							#{payNo}
					)
	</insert>
	<!-- 결재문서 연차계 삽입-->
	<insert id="offDataInsert" parameterType="PaymentVO">
		INSERT INTO payment_off(title,content,com,use_date,return_date,pay_no)
					VALUES(
							#{title},
							#{content},
							<choose>
							<when test="com != null and !com.equals('')">
							#{com},
							</when>
							<otherwise>
								'',
							</otherwise>
							</choose>
							#{useDate},
							#{returnDate},
							#{payNo}
					)
	</insert>
	<!-- 결재문서 품의서 삽입-->
	<insert id="robinDataInsert" parameterType="PaymentVO">
		INSERT INTO payment_robin(title,content,com,pay_no)
					VALUES(
							#{title},
							#{content},
							<choose>
							<when test="com != null and !com.equals('')">
							#{com},
							</when>
							<otherwise>
								'',
							</otherwise>
							</choose>
							#{payNo}
					)
	</insert>
	<!-- 결재문서 운행일지 조회-->
	<select id="logList" resultType="PaymentVO">
		SELECT * FROM payment p, payment_logbook l
			WHERE p.pay_no = l.pay_no
			AND p.id = #{id}
	</select>
	<!-- 결재문서 연차계 조회-->
	<select id="offList" resultType="PaymentVO">
		SELECT * FROM payment p, payment_off o
			WHERE p.pay_no = o.pay_no
			AND p.id = #{id}
	</select>
	<!-- 결재문서 품의서 조회-->
	<select id="robinList" resultType="PaymentVO">
		SELECT * FROM payment p, payment_robin r
			WHERE p.pay_no = r.pay_no
			AND p.id = #{id}
	</select>
	<!-- 결재문서 전체 일괄조회-->
</mapper>