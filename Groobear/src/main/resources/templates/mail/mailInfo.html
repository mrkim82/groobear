<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
 layout:decorate="~{layout/mailTiles}">
<head>
<meta charset="UTF-8">
<title>메일 단건 상세조회 페이지</title>
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<style>
	input:focus{
		outline:none;
	}
	textarea:focus{
		outline:none;
	}
</style>
</head>
<body layout:fragment="content">
<h3 class="dohyeon" style="font-size:35px;margin-top:20px;">G-Mail  </h3>
	<table class="table dohyeon">
        <tr>
            <td>제목<input type="text" th:value="${mail.title}" readonly style="position: absolute;left: 120px;border: 0;"/><input th:value="${#dates.format(mail.sendDate, 'yyyy.MM.dd')}" readonly style="border:0;position: absolute;right: 0;"/></td>
        </tr>
        <tr>
            <td>보낸사람<input type="text" th:value="${mail.sender}" readonly style="position: absolute;left: 120px;border: 0;"/></td>
        </tr>
        <tr>
            <td>받는사람<input type="text" th:value="${mail.receiver}" readonly style="position: absolute;left: 120px;border: 0;"/></td>
        </tr>
        <tr th:if="${refCheck == 'A'} and ${not #strings.isEmpty(mail.referrer)}">
        	<td>참조자<input type="text" th:value="${mail.referrer}" readonly style="position: absolute;left: 120px;border: 0;"></td>

        </tr>
        
        <th:block th:if="${refCheck == 'B'}">
	        <tr th:if="${not #strings.isEmpty(mail.referrer)} and ${#strings.isEmpty(mail.referrer2)}">
	        	<td>참조자<input type="text" th:value="${mail.referrer}" readonly style="position: absolute;left: 120px;border: 0;"></td>
	        </tr>
	        <tr th:if="${not #strings.isEmpty(mail.referrer)} and ${not #strings.isEmpty(mail.referrer2)} and ${#strings.isEmpty(mail.referrer3)}">
	        	<td>참조자<input type="text" th:value="${mail.referrer}+', '+${mail.referrer2}" readonly></td>
	        </tr>
	        <tr th:if="${not #strings.isEmpty(mail.referrer)} and ${not #strings.isEmpty(mail.referrer2)} and ${not #strings.isEmpty(mail.referrer3)}">
	        	<td>참조자<input type="text" th:value="${mail.referrer}+', '+${mail.referrer2}+', '+${mail.referrer3}" readonly></td>
	        </tr>
        </th:block>
        <tr>
			<td>
				<div class="bigPictureWrapper">
					<div class="bigPicture">
					</div>
				</div>
	     		<div class = "row">
					<div class = "col-lg-12">
						<div class = "panel-heading"></div>
						<!-- /.panel-heading -->
							<div class = "panel-body">
								<div class = "uploadResult">첨부파일
									<ul>
									</ul>
								</div>
							</div>
					<!-- end panel body -->
					</div>
					<!-- end panel -->
				</div>
	        </td>
        </tr>
        <tr>
        <td>
	        <textarea th:text="${mail.content}" style="width:100%; height:400px; border:0;" readonly></textarea>
        </td></tr>
    </table>
    <script>
    $.getJSON(`/getAttach?mailNo=[[${mail.mailNo}]]`, function(arr) {
        var str = "";
        console.log('들어는와짐');
        $(arr).each(function(i, attach){
            console.log("여기도 들어와짐");
            if(attach.fileType){
                var fileCallPath = encodeURIComponent(attach.uploadPath + "/s_" + attach.uuid + "_" + attach.fileName);
                str += "<li style='list-style-type:none' data-path='" + attach.uploadPath + "' data-uuid='" + attach.uuid + "' data-filename='"
                + attach.fileName + "' data-type='" + attach.fileType + "'><div>";
                //str += "<img src='/display?fileName=" + fileCallPath + "'>";
                str += "</div>";
                str += "</li>";
            } else {
                str += "<li data-path='" + attach.uploadPath + "' data-uuid='" + attach.uuid + "' data-filename='"
                + attach.fileName + "' data-type='" + attach.fileType + "'><div>";
                str += "<span>" + attach.fileName + "</span><br/>";
                //str += "<img src='img/attach.png/'>";
                str += "</div>";
                str += "</li>";
            }
        });
        
        $(".uploadResult ul").html(str);
    });
		$(".uploadResult").on("click","li", function(e){
	      
		    console.log("view image");
		    
		    var liObj = $(this);
		    
		    var path = encodeURIComponent(liObj.data("path")+"/" + liObj.data("uuid")+"_" + liObj.data("filename"));
		    
		    if(liObj.data("type")){
		      //showImage(path.replace(new RegExp(/\\/g),"/"));
		      //self.location ="/download?fileName="+path
		    }else {
		      //download 
		      self.location ="/download?fileName="+path
		    }
		  });
		function showImage(fileCallPath){
		    
		    alert(fileCallPath);
		    
		    $(".bigPictureWrapper").css("display","flex").show();
		    
		    $(".bigPicture")
		    .html("<img src='/display?fileName="+fileCallPath+"' >")
		    .animate({width:'100%', height: '100%'}, 1000);
		  }
		  $(".bigPictureWrapper").on("click", function(e){
		    $(".bigPicture").animate({width:'0%', height: '0%'}, 1000);
		    setTimeout(function(){
		      $('.bigPictureWrapper').hide();
		    }, 1000);
		  });
		  var regex = new RegExp("(.*?)\\.(sh|alz)$"); //제외하고 싶은 확장자.
		    var maxSize = 5242880;
		
		    function checkExtension(fileName, fileSize) {
		        if (fileSize >= maxSize) {
		            alert('파일 사이즈 초과');
		            return false;
		        }
		        if (regex.test(fileName)) {
		            alert('해당 종류의 파일은 업로드할 수 없습니다.');
		            return false;
		        }
		        return true;
		    }
    </script>
</body>
</html>