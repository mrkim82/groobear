<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/proPostTiles}"
>
<head>
<script>
	let projectNo22 = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);
</script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load('current', {'packages':['gantt']});
  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {

    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Task ID');
    data.addColumn('string', 'Task Name');
    data.addColumn('string', 'Resource');
    data.addColumn('date', 'Start Date');
    data.addColumn('date', 'End Date');
    data.addColumn('number', 'Duration');
    data.addColumn('number', 'Percent Complete');
    //data.addColumn('string', 'Dependencies');//상위업무

    fetch("/gantt", {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify(projectNo)
	})
	.then(response => response.json())
	.then(res => {
		console.log(data)
		let rawData = res;
		console.log(rawData)
		
		// 데이터 변환 함수
		function convertToChartData(rawData) {
		  const chartData = [];
		  const currentTime = new Date(); // 현재 시간
		  
		  rawData.forEach((item) => {
		    const startDate = new Date(item.workStartTime);
		    const endDate = new Date(item.workEndTime);
		    if (!isNaN(startDate) && !isNaN(endDate)) {
		        const diffTime = currentTime - startDate; // 현재 시간과 작업 시작 시간의 차이 (밀리초)
		        const diffDay = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // 차이를 일(day)로 변환 (내림)
		        
		        chartData.push([
		          String(item.proPostNo), // 1열에 proPostNo 삽입
		          item.postTitle, // 2열에 postTitle 삽입
		          '긴급', // 3열에 고정 값 '긴급' 삽입
		          startDate, // 4열에 작업 시작 시간 삽입
		          endDate, // 5열에 작업 끝 시간 삽입
		          diffDay, // 6열은 현재 시간과 작업 시작 시간의 차이 (일단위)
		          100 // 7열은 고정 값 100 삽입
		          //null // 8열은 null로 삽입
		        ]);
		      }
		    console.log(chartData)
		  });
		  return chartData;
		}

		// 변환된 데이터
		const chartData = convertToChartData(rawData);
		console.log(chartData)
		// 변환된 데이터를 data.addRows에 삽입
		data.addRows(chartData);
		
	});    
    
    
    /* data.addRows([
      ['2014Spring', 'Spring 2014', 'spring',
       new Date(2014, 2, 22), new Date(2014, 5, 20), null, 100, null],
      ['2014Summer', 'Summer 2014', 'summer',
       new Date(2014, 5, 21), new Date(2014, 8, 20), null, 100, null],
      ['2014Autumn', 'Autumn 2014', 'autumn',
       new Date(2014, 8, 21), new Date(2014, 11, 20), null, 100, null],
      ['2014Winter', 'Winter 2014', 'winter',
       new Date(2014, 11, 21), new Date(2015, 2, 21), null, 100, null],
      ['2015Spring', 'Spring 2015', 'spring',
       new Date(2015, 2, 22), new Date(2015, 5, 20), null, 50, null],
      ['2015Summer', 'Summer 2015', 'summer',
       new Date(2015, 5, 21), new Date(2015, 8, 20), null, 0, null],
      ['2015Autumn', 'Autumn 2015', 'autumn',
       new Date(2015, 8, 21), new Date(2015, 11, 20), null, 0, null],
      ['2015Winter', 'Winter 2015', 'winter',
       new Date(2015, 11, 21), new Date(2016, 2, 21), null, 0, null],
      ['Football', 'Football Season', 'sports',
       new Date(2014, 8, 4), new Date(2015, 1, 1), null, 100, null],
      ['Baseball', 'Baseball Season', 'sports',
       new Date(2015, 2, 31), new Date(2015, 9, 20), null, 14, null],
      ['Basketball', 'Basketball Season', 'sports',
       new Date(2014, 9, 28), new Date(2015, 5, 20), null, 86, null],
      ['Hockey', 'Hockey Season', 'sports',
       new Date(2014, 9, 8), new Date(2015, 5, 21), null, 89, null]
    ]); */

    var options = {
      height: 400,
      gantt: {
        trackHeight: 30
      }
    };

    var chart = new google.visualization.Gantt(document.getElementById('chart_div'));

    chart.draw(data, options);
  }
  
</script>

</head>
<body layout:fragment="content">
	<div>간트차트</div>
	<div id="chart_div" class="float-start" style="width:1000px"></div>
</body>
</html>