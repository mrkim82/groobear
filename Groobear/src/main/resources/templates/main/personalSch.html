<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/tiles}"
	  >
<th:block layout:fragment="content" class="dohyeon">

<style>
#calendar {
    max-width: 1200px;
    margin: 0 auto;
    margin: 0px 0px;
    padding: 0;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    font-size: 14px;
}
.custom-modal {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 670px;
    background-color: #f8f9fa;
    box-shadow: -1px 0px 3px rgba(0, 0, 0, 0.2);
    transform: translateX(100%);
    transition: transform 0.3s;
}

.btn-groob {
	background-color: #35A880;
	color: #fff;
	border: 1px solid #35A880;
	border-radius: 12px;
}

.btn-groobl {
	background-color: #6198d3;
	color: #fff;
	border: 1px solid #35A880;
	border-radius: 12px;
}

.show-modal {
    transform: translateX(0);
    z-index: 9999;
}

.modal-header {
    padding: 10px;
    background-color: #6198d3;
    color: #fff;
}

.modal-body {
    padding: 10px;
}

.modal-footer {
    padding: 10px;
    background-color: #f8f9fa;
    text-align: right;
}

.spanCursor {
	cursor: pointer
}
textarea {
  padding: 10px;
  font-size: 14px;
  padding: 10px;
  height: 200px;
  width: 100%;
  resize: vertical; /* 세로 조정 가능 */
  border: none;
  outline: none;
  border-top: 1px solid #ddd;
}
/* 검색 창 스타일 */
input[type="text"] {
	width: 150px; /* 원하는 너비 값으로 변경 */
	padding: 8px 12px;
	border: 1px solid #ccc;
	border-radius: 20px;
	font-size: 16px;
	outline: none;
	transition: width 0.3s ease-in-out;
}

/* 검색 창에 포커스되었을 때 스타일 */
input[type="text"]:focus {
	width: 170px; /* 포커스되었을 때 더 넓은 너비 값으로 변경 */
	border-color: #6c63ff;
	box-shadow: 0 0 5px rgba(108, 99, 255, 0.5);
}

.dohyeonModalContent {
	border: 1px solid #00000021;
	border-radius: 20px;
	box-shadow: 2px 4px 3px 3px darkgray;
}
.fc {
  margin: 0;
}
</style>

<h1 style="margin-top:30px; margin-left:10px;" th:text="${session.Name} + '의 개인 캘린더'"></h1>
<div style="text-align:right; margin-right:30px; margin-bottom:30px;">
	<button type="button"
			class="btn btn-groobl"
			data-toggle="modal"
			data-target="#creSchModal">
		개인 일정 생성
	</button>
</div>

<!-- 일정 생성 모달 -->
<div class="modal fade modal-dialog-scrollable" 
	 id="creSchModal"
	 tabindex="-1"
	 aria-labelledby="creSchModalLabel"
	 role="dialog"
	 aria-hidden="true"
	 style="display:none">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content dohyeonModalContent" style="height: 500px;">
      <div class="modal-header" style="background-color:#6198d3;">
        <h5 class="modal-title" id="creSchModalLabel">개인 일정 생성</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      	<!-- 제목 -->
      	<div style="margin-bottom: 10px;">
			<input type="text" placeholder="제목을 입력하세요." class="postTitle" maxlength="30" style="width: 100%;">
		</div>
		<!-- 시작일 -->
		<div style="margin-bottom: 7px;">
			<p style="margin-bottom: 2px;">시작일</p>
			<input type="datetime-local"
				   id="startSchDate"
				   class="form-control"
				   style="margin-left: 3px; width: 210px; border-radius: 5px;">
		</div>
		<!-- 마감일 -->
		<!-- 마감일 -->
		<div style="margin-bottom: 7px;">
			<p style="margin-bottom: 2px;">마감일</p>
			<input type="datetime-local"
				   th:min="${#dates.format(cTime, 'yyyy-MM-dd HH:mm')}"
				   id="endSchDate"
				   class="form-control"
				   style="margin-left: 3px; width: 210px; border-radius: 5px;">
		</div>
		<!-- 장소 -->
		<div style="margin-bottom: 7px;">
			<p style="margin-bottom: 2px;">장소</p>
			<input type="text" class="schPlace" placeholder="장소를 입력하세요." style="width: 300px;" maxlength="30">
		</div>
		<!-- 내용 -->
		<div>
			<textarea placeholder="내용을 입력하세요." class="schText" maxlength="999"></textarea>
		</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-groobl" onclick="createSchButton()">등록</button>
        <button type="button" class="btn btn-groobl" data-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 캘린더 위치 -->
<div id='calendar'></div>
	
<!-- 일정 상세조회 모달 -->
<div class="custom-modal"
		 th:each="calD : ${readPerCalDetail}"
		 th:id="'modal' + ${calD.proPostNo}"
		 th:data-feed-post-sch-no="${calD.proPostNo}"
		 th:data-sch-no="${calD.schNo}"
		 style="font-size:15px;">
		 
	<div class="modal-header">
		<div class="modal-title" style="display: flex;">
		 <div style="display: flex; flex-direction: column; margin-left:12px;">
			<span th:text="'개인일정 : ' + ${calD.postTitle}" style="font-size:17px;"></span>
	        <span th:text="${#dates.format(calD.postDate, 'yyyy-MM-dd HH:mm')}"
	              style="color: #dfdfdf; font-size:14px; margin-left:20px;"></span>
	    </div>
        
		</div>
        <div style="display:inline; margin-left: auto; text-align:right;">
	        <span onclick="deletePost()" class="spanCursor">삭제</span>
	       <button type="button"
								class="close closeModalButton"
								aria-label="Close">
	       	<span aria-hidden="true">&times;</span>
	       </button>
        </div>
   	</div>

	<!-- 날짜 -->
   	<div class="modal-body">
   		<div style="margin-bottom: 7px;">
	   		<p style="margin-bottom: 2px;">시작일</p>
			<input type="datetime-local"
				   class="form-control"
				   th:value="${#dates.format(calD.schStartTime, 'yyyy-MM-dd HH:mm')}"
				   style="margin-left: 3px; width: 210px; border-radius: 5px;"></input>
		</div>
		<div style="margin-bottom: 7px;">
		<p style="margin-bottom: 2px;">마감일</p>
			<input type="datetime-local"
				   class="form-control"
				   th:value="${#dates.format(calD.schEndTime, 'yyyy-MM-dd HH:mm')}"
				   th:min="${#dates.format(cTime, 'yyyy-MM-dd HH:mm')}"
				   style="margin-left: 3px; width: 210px; border-radius: 5px;"></input>
		</div>
		<div th:if="${calD.schPlace != null}" th:text="'장소 : ' + ${calD.schPlace}"></div>
    </div>
    
    <!-- 내용 -->
    <div class="modal-body">
		<div th:if="${calD.schContent != null}" th:text="'내용 : ' + ${calD.schContent}"></div>
    </div>
    
	<!-- 북마크, 댓글수 -->
    <div class="modal-footer">
		<div class="col-md-8">
			<ul class="list-unstyled">
				<li th:each="com : ${readPerCalCom}"
						th:data-post-code="${com.comNo}"
						th:if="${calD.proPostNo == com.proPostNo}">
					<th:block th:if="${com.uploadPath != null}">
						<img th:src="@{|/display?fileName=${#strings.replace(com.uploadPath,'\','/')}/s_${com.uuid}_${com.fileName}|}"
		  		 			 class="card-img-top"
		  		 			 style="width:30px; height:30px; margin:0px;">
		  		 	</th:block>
		  		 	<th:block th:if="${com.uploadPath == null}">
						<img style="width:30px; height:30px; margin:0px;"
					 		 src="../img/userProf.png">
					</th:block>
					<span th:text="${com.name}"></span>
					<span th:text="${#dates.format(com.comDate, 'yyyy-MM-dd HH:mm')}"></span>
					<span th:text="${com.comContent}"></span>
					<span onclick="UpdateWritingComment()" class="spanCursor" style="color: red">수정</span>
					<span></span><!-- 지우면 안됨!!!!!!! -->
					<span onclick="deleteWritingComment()" class="spanCursor">X</span>
				</li>
			</ul>
		</div>
		<div class="col-md-4">
			<div class="form-group">
				<input type="text" class="form-control" placeholder="댓글 작성">
			</div>
			<button type="button" class="btn btn-groobl" onclick="createCommentButton()">댓글 등록</button>
		</div>
    </div>
    
</div>
	
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script th:src="@{https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js}"></script>
<script src="/fullcalendar-6.1.8/dist/index.global.js"></script>

<!-- 데이터 가져오기 -->
<script type="text/javascript" th:inline="javascript">
	/*<![CDATA[*/
		let schAllDatas = /*[[${readPersonalSch}]]*/;
	/*]]>*/
</script>


<!-- 달력 load -->
<script>
let navTop;//삭제시 바 지우기용
var calendarEl = document.getElementById('calendar');
let allEvents = schAllDatas;

//달력 데이터 만들기
let formattedEvents = allEvents.map(eventData => ({
	title: eventData.title,
	start: eventData.start,
	end: eventData.end,
	color: eventData.proNo == 7 ? '#6198d3' : '#35A880',
	classNames: 'sideWork spanCursor',
	extendedProps: {
		proNo: eventData.proNo,
		proPostNo : eventData.proPostNo
	}
}));

var calendar = new FullCalendar.Calendar(calendarEl, {
	headerToolbar: {
		left: 'prev,next today',
		center: 'title',
		right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
	},
	eventClick: function(info) {
		navTop = event.target.closest('.fc-event');//바 위치
		let proNo = info.event.extendedProps.proNo;
		let proPostNo = info.event.extendedProps.proPostNo;
      
		if(proNo == 7) {//개인용 일정인 경우
			var $buttons = $('.sideWork');
			var $modals = $('.custom-modal');
		     
			//모달 전체 닫기
			$modals.not('#modal' + proPostNo).removeClass('show-modal');
			$('#modal' + proPostNo).toggleClass('show-modal');
			// X버튼으로 닫기
			$('.closeModalButton').click(function () {
				$(this).closest('.custom-modal').removeClass('show-modal');
			});
			
		} else {//프로젝트(일정)인 경우 해당 프로젝트로 보냄
			location.href="/proPostMain/" + proNo + "?homeTab=4";
		}

    },
    dayMaxEventRows: true,
    views: {
		timeGrid: {
			dayMaxEventRows: 3
		}
    },
    initialDate: new Date(),
    navLinks: true,
    businessHours: false,
    editable: false,
    selectable: false,
	events: formattedEvents
});

calendar.render();
</script>

<!-- 댓글 등록 -->
<script>
function createCommentButton() {
	let targetButton = event.target;//버튼 동적 확인
	let com = targetButton.parentNode.children[0].children[0]; //텍스트값 찾기
	if(com.value == '') {
		com.focus();
		alert('댓글을 입력하세요');
		return;
	}
	
	let proPostNo = targetButton.closest('.custom-modal').dataset.feedPostSchNo;//글번호 찾기
	
	fetch("/postCreateComment", {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify({
  				'proPostNo': proPostNo,
  				'comContent': com.value
  			})
	})
	.then(response => response.json())
	.then(res => {
		let insertComment = targetButton.closest('.modal-footer').getElementsByClassName('list-unstyled')[0];
		insertComment.insertAdjacentHTML('beforeend', 
			'<li data-post-code="' + res.result + '">'+
				'<span></span>'+
				'<span>' + selfName + '</span>'+
				'<span>' + formatDate() + '</span>'+
				'<span>' + com.value + '</span>'+
				'<span onclick="UpdateWritingComment()" class="spanCursor" style="color: red">수정</span>'+
				'<span></span>'+
				'<span onclick="deleteWritingComment()" class="spanCursor">X</span>'+
			'</li>'
		);
		com.focus();
		com.value = '';
	})
}
</script>

<!-- 댓글 삭제  -->
<script>
function deleteWritingComment() {
	let targetButton = event.target;
	
	fetch("/postDeleteComment", {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify({
				 'comNo': targetButton.parentNode.dataset.postCode
			 })
	})
	.then(response => response.json())
	.then(res => {
		targetButton.parentNode.remove()
	});
}
</script>

<!-- 댓글 수정  -->
<script>
function UpdateWritingComment() {
	let targetButton = event.target;
	let comNo = targetButton.parentNode.dataset.postCode;//댓글 번호
	
	let oldCom = targetButton.parentNode.children[3].textContent;//기존 댓글
	let oldDate = targetButton.parentNode.children[2].textContent;//기존 날짜, 후에 수정x, 다시 불러 오는 용도
	
	//초기화
	targetButton.parentNode.children[2].textContent = '';//날짜 초기화
	targetButton.parentNode.children[3].textContent = '';//댓글 초기화
	targetButton.parentNode.children[4].textContent = '';//수정 초기화
	targetButton.parentNode.children[6].textContent = '';//X 초기화
	
	if(document.getElementById('newComment') != null) {
		let nC = document.getElementById('newComment').parentNode.parentNode;
		nC.childNodes[5].textContent = document.getElementById('newComment').dataset.comDate;
		nC.childNodes[7].textContent = document.getElementById('newComment').value;
		nC.childNodes[9].textContent = '수정';
		nC.childNodes[11].textContent = '';
		nC.childNodes[13].textContent = 'X';
	}
	
	targetButton.parentNode.children[5].innerHTML = 
			'<input type="text" data-com-date="' + oldDate + '" placeholder="댓글 수정" id="newComment" value="' + oldCom + '">'
			+'<span id="ooo" class="spanCursor">수정</span>'
			+'<span id="xxx" class="spanCursor">취소</span>';
	
	// 취소버튼
	document.getElementById('xxx').addEventListener('click', function() {
		targetButton.parentNode.children[2].textContent = oldDate;
		targetButton.parentNode.children[3].textContent = oldCom;
		targetButton.parentNode.children[4].textContent = '수정';
		targetButton.parentNode.children[5].textContent = '';
		targetButton.parentNode.children[6].textContent = 'X';
	});
	
	// 수정버튼
	document.getElementById('ooo').addEventListener('click', function() {
		let newCom = document.getElementById('newComment');
		if(newCom.value == '') {
			newCom.focus();
			alert('댓글을 수정하세요');
		} else {
			
			fetch("/postUpdateComment", {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					'comContent' : newCom.value,
						 'comNo': comNo
					 })
			})
			.then(response => response.json())
			.then(res => {
				
				if(res.result == '성공') {
					targetButton.parentNode.children[2].textContent = oldDate;
					targetButton.parentNode.children[3].textContent = newCom.value;
					targetButton.parentNode.children[4].textContent = '수정';
					targetButton.parentNode.children[6].textContent = 'X';
					targetButton.parentNode.children[5].textContent = '';
					
				} else {
					alert('댓글 수정 실패');
				}
			});
		}
	});
	
}
</script>

<!-- java값 가져오기 -->
<script type="text/javascript" th:inline="javascript">
	/*<![CDATA[*/
		
		let selfId = /*[[${session.Id}]]*/;
		let selfName = /*[[${session.Name}]]*/;
		
	/*]]>*/
</script>

<!-- 일정 등록 -->
<script>
function createSchButton() {
	let schTitle = creSchModal.querySelector('.postTitle');
	if(schTitle.value == '') {
		alert('제목 입력');
		return;
	};

	let schStartDate = creSchModal.querySelector('#startSchDate');
	let schEndDate = creSchModal.querySelector('#endSchDate');
	let schPlace = creSchModal.querySelector('.schPlace');
	let schText = creSchModal.querySelector('.schText');
	
	if(schStartDate.value == '' && schEndDate.value == '') {
		alert('시작 날짜는 선택해주세요');
		return false;
	};
	
	if((schStartDate.value > schEndDate.value) && schEndDate.value != '') {
		alert('시작 날짜는 끝날짜보다 작아야함');
		return false;
	};
	
	//FullCalendar allDay 속성은 컬럼이 필요해서 임의 값 넣어주기로 설정
	if(schStartDate.value == '') {
		schStartDate.value = schEndDate.value;
	};
	
	let schObj = {  'proNo' : 7,//개인 일정 관리자 프로젝트
					'postTitle' : schTitle.value,
					'schStartDay' : convertToFormattedDateTime(schStartDate.value),
					'schStartTime' : convertToFormattedDateTime(schStartDate.value),
					'schEndDay' : convertToFormattedDateTime(schEndDate.value),
					'schEndTime' : convertToFormattedDateTime(schEndDate.value),
					'schPlace' : schPlace.value,
					'schContent' : schText.value,
					'personalSch' : 'Y',//개인 일정은 Y
					};
		
	fetch("/creSch", {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify(schObj)
	})
	.then(response => response.json())
	.then(res => {
		location.reload();
	})
	.catch(error => {
		console.error('Error: ',error);
	});
}
</script>

<!-- 글 삭제 -->
<script>
function deletePost() {
	let topTarget = event.target.closest('.custom-modal');
	let delProPostNo = Number(topTarget.dataset.feedPostSchNo);
	
	fetch('/delProPost', {
		method: 'POST',
	       headers : {
	           'Content-Type': 'application/json'
	       },
	       body : JSON.stringify(delProPostNo)
	})
	.then(response => response.json())
	.then(res => {
		if(res.result == '성공') {
			topTarget.remove();
			navTop.remove();
		};
		
	});
}
</script>

<!-- 시간 -->
<script type="text/javascript">
//현재 시간 가져오기
function formatDate() {
	let date = new Date();
	const year = date.getFullYear();
	const month = String(date.getMonth() + 1).padStart(2, '0');
	const day = String(date.getDate()).padStart(2, '0');
	const hours = String(date.getHours()).padStart(2, '0');
	const minutes = String(date.getMinutes()).padStart(2, '0');
	
	return `${year}/${month}/${day} ${hours}:${minutes}`;
}

//당일
function convertToFormattedDateTime(dateTimeStr) {
	if(dateTimeStr == '') {//빈값일때 바로 리턴
		return;
	}
	
	const date = new Date(dateTimeStr);
	const year = date.getFullYear();
	const month = String(date.getMonth() + 1).padStart(2, '0');
	const day = String(date.getDate()).padStart(2, '0');
	const hours = String(date.getHours()).padStart(2, '0');
	const minutes = String(date.getMinutes()).padStart(2, '0');
	
	return `${year}-${month}-${day} ${hours}:${minutes}`;
}
	
//하루 전
function bDay(dateTimeStr) {
	const date = new Date(dateTimeStr);
	// 날짜에서 하루를 빼줍니다.
	date.setDate(date.getDate() - 1);
	
	const year = date.getFullYear();
	const month = String(date.getMonth() + 1).padStart(2, '0');
	const day = String(date.getDate()).padStart(2, '0');
	const hours = String(date.getHours()).padStart(2, '0');
	const minutes = String(date.getMinutes()).padStart(2, '0');
	
	return `${year}-${month}-${day} ${hours}:${minutes}`;
};

//하루 후
function aDay(dateTimeStr) {
	const date = new Date(dateTimeStr);
	// 날짜에서 하루를 빼줍니다.
	date.setDate(date.getDate() + 1);
	
	const year = date.getFullYear();
	const month = String(date.getMonth() + 1).padStart(2, '0');
	const day = String(date.getDate()).padStart(2, '0');
	const hours = String(date.getHours()).padStart(2, '0');
	const minutes = String(date.getMinutes()).padStart(2, '0');
	
	return `${year}-${month}-${day} ${hours}:${minutes}`;
};
</script>

</th:block>
</html>