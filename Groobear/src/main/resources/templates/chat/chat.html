<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Document</title>
<link rel="icon" href="/img/bear.png" type="image/x-icon"> 
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>	
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
 <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
 <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" >

 <style>
 .material-symbols-outlined {
  font-variation-settings:
  'FILL' 0,
  'wght' 500,
  'GRAD' 0,
  'opsz' 58
}
.room-title {
    color:#000000;
    font-size: 25px;
    font-weight: 900;
}

/* .message {
    color: #000000; /* 검정색 
} */
    * {
        margin: 0;
        padding: 0;
        font-family: 'Do Hyeon', sans-serif;
    }
    body {
	/*background-color: #CCFFCC;  */
    background-color: #9deab78a;
    min-height: 100%;
    font-size: 20px; /* 원하는 크기로 변경 */
}
    .chat_wrap .header {
        font-size: 14px;
        padding: 15px 0;
        background: #35a880;
        color: white;
        text-align: center;
        position: fixed;
        width: 100%;
        z-index: 100;
    }
    .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 10px;
    position: relative; /* 상대 위치 지정 */
}


.header .room-title {
    position: absolute; /* 절대 위치 지정 */
    left: 50%; /* 왼쪽으로부터 50% 위치에 배치 */
    transform: translateX(-50%); /* 자신의 너비의 절반만큼 왼쪽으로 이동해서 정확히 중앙에 배치 */
}

.header .header-icons {
    margin-left: 470px;
    display: flex;
    gap: 20px; /* 아이콘 사이의 간격을 조절합니다. */
    color: #000000;
    
    /* margin-right: auto; */
}
    .header a i {
        color: white;  /* Icon color */
        font-size: 24px;  /* Icon size */
    }
    
    
    .header .header-buttons {
        display: flex;
    }
    
    .header .header-buttons a {
        margin-left: 10px;
    }
    
    .chat_wrap .chat {
        padding-top: 60px;
        height: calc(100vh - 160px);  
        overflow-y: scroll; 
    }
    
    .chat_wrap .chat ul {
        width: 100%;
        list-style: none;
    }
    
    .chat_wrap .chat ul li {
        width: 100%;
    }
    
    .chat_wrap .chat ul li.left {
        text-align: left;
    }
    
    .chat_wrap .chat ul li.right {
        text-align: right;
    }
    .chat_wrap .chat ul li.middle{
        text-align : flex;
    }	
    
    .chat_wrap .chat ul li>div {
        font-size: 13px;
    }
    
    .chat_wrap .chat ul li>div.sender {
        margin: 10px 20px 0 20px;
        font-weight: bold;
        font-size: 20px;
    }
    
    .chat_wrap .chat ul li>div.message {
        display: inline-block;
        word-break: break-all;
        margin: 5px 20px;
        max-width: 75%;
        border: 1px solid #888;
        padding: 10px;
        border-radius: 5px;
        background-color: #FCFCFC;
        color: #555;
        text-align: left;
        font-size: 20px;
    }
    
    .chat_wrap .input-div {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: #FFF;
        text-align: center;
        border-top: 1px solid #F18C7E;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat_wrap .input-div>textarea {
        flex-grow: 1;
        height: 100px; /* textarea의 높이를 조정합니다 */
        border: none;
        padding: 10px;
        margin-right: 10px;
    }
    
    .chat_wrap .input-div>button {
        width: 100px;
        height: 60px;
        background-color: #35a880;
        color: white;
        border: none;
        border-radius: 5px;
    }
    
    .format {
        display: none;
    }
    .message-time {
        color: #777;      /* 시간 텍스트의 색상을 설정합니다. */
        margin-right: 30px;
        margin-left: 30px;
        font-size: inherit;
    }
    #membersDiv {
  position: relative;
  display: inline-block;
  cursor: pointer;
}

#membersDiv .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: #555;
  color: #fff;
  text-align: center;
  padding: 5px 0;
  border-radius: 6px;
  position: absolute;
  z-index: 1;
  bottom: 125%; /* 위치는 원하는대로 조절하세요 */
  left: 50%;
  margin-left: -60px;
  opacity: 0;
  transition: opacity 0.3s;
}

#membersDiv:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
.cursor{
    cursor: pointer; 
}
.tooltip-content {
    display: none;
    position: absolute;
    width: 100px;
    background-color: #f9f9f9;  /* 배경색을 설정합니다 */
    color: #333;                /* 글자색을 설정합니다 */
    border: 1px solid #ddd;     /* 테두리를 설정합니다 */
    padding: 10px;              /* 내부 여백을 설정합니다 */
    border-radius: 8px;         /* 테두리 모서리를 둥글게 만듭니다 */
    box-shadow: 0 4px 6px 0 rgba(0,0,0,0.1);  /* 상자 그림자를 설정합니다 */
    z-index: 1000;              /* 상자를 다른 요소 위로 띄웁니다 */
    left: 0;                    /* 툴팁을 상대적 위치의 왼쪽 끝으로 배치합니다 */
    white-space: normal;
}
.tooltip-content p {
    margin: 5px 0;  /* 위아래 마진을 5px로 설정 */
    padding: 0;  /* 패딩을 0으로 설정 */
}
.message-content{
    color:#000000;
    font-family: 'Do Hyeon';
}
.modal-body li {
    list-style-type: none;
}
.modal-body li input{
    margin-right: 5px;
}


    </style>
</head>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<body>
	<div class="chat_wrap">
		<div class="header">
            <div class="room-title">[[${roomDTO.roomName}]]</div>
            <div class="header-icons">
                <div id="membersDiv">
                    <span class="cursor" id="memberList"><span class="material-symbols-outlined">
                        patient_list
                        </span></span>
                    <div class="tooltip-content">
                        대화상대
                        <span th:each="user : ${usersName}">
                            <p th:text="${user.inRoomUserName}"></p>
                        </span>
                    </div>
                </div>
                <span class="cursor" data-toggle="modal" data-target="#inviteModal"><i class="material-icons">group_add</i></span> <!-- Invite Icon -->
                <!-- 나가는버튼 -->
                <span class="cursor" id="deleteChatroomButton"><i class="material-icons">exit_to_app</i></span> <!-- Exit Icon -->
            </div>
        </div>
        
		<div class="chat">
			<ul>
				<!-- 동적 생성 -->
			</ul>
		</div>
		
		<div class="input-div">
			<textarea placeholder="Press Enter for send message."></textarea>
			<button id="sendMessageBtn">Send</button>
		</div>
		
		<!-- format -->

		<!-- <div class="chat format">
		<ul class="chat-messages" id="chatRoom">
    <div th:each="message : ${chatDTO}">
        <div th:each="image : ${profileImages}">
            <div th:if="${message.id} == ${image.id}">
                <img class="message-profile-pic" th:src="${image.uploadPath}" alt="Profile Image">
                <li class="message">
                <div class="sender">
						<span></span>
					</div>
                    <span class="message-content"></span>
                    <small class="message-time"></small>
                </li>
            </div>
        </div>
    </div>
</ul> -->
<!-- <div class="chat format">
<div th:each="message : ${chatDTO}">
    <div class="message-container">
        <div class="sender">
            <th:block th:if="${message.profileImage.uploadPath != null}">
                <img th:src="@{|/display?fileName=${#strings.replace(message.profileImage.uploadPath,'\','/')}/s_${message.profileImage.uuid}_${message.profileImage.fileName}|}" class="card-img-top">
            </th:block>
            <th:block th:if="${message.profileImage.uploadPath == null}">
                <img id="profImg" style="width:50px;height:50px;" src="../img/userProf.png">
            </th:block>
            <span></span>
        </div>
        <div class="message">
            <span class="message-content" th:text="${message.content}"></span>
        </div>
        <div class="message2">
            <small class="message-time" th:text="${message.time}"></small>
        </div>
    </div>
</div>
</div> -->

<!-- 기존 메세지 코드. -->
 <div class="chat format">
			<ul>
				<li>
					<div class="sender">
                        <!-- <div class="profile" style="height: 100px; background-repeat: no-repeat; background-image: url('/img/userProf.png');"></div> -->
                        <div class="profile" style=" background-repeat: no-repeat; background-image: url('/img/userProf.png');"></div>
						<span></span>
						
					</div>
					<div class="message">
						<span class="message-content"></span>
					</div>
                    <div class="message2">
                    <small class="message-time"></small>
                </div>
				</li>
			</ul>
		</div>
	</div>
<!-- 기존 메세지 코드. -->   

	<!-- The Modal -->
    <div class="modal" id="inviteModal">
        <div class="modal-dialog" style="width: 500px; ">
            <div class="modal-content" style="border: 1px solid #00000021;border-radius: 20px;box-shadow: 2px 4px 3px 3px darkgray;">

                <!-- Modal Header -->
                <div class="modal-header" style="border-bottom: 1px solid #dee2e6;">
                    <h4 class="modal-title">초대하기</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body" style="justify-content: space-evenly; color: black; height: auto;">
                
                    <ul id="employeeList"></ul>
                    <div id="userListContainer">
         <!-- 사용자 목록이 이곳에 표시됩니다 -->
    					</div>
                </div>
				
                <!-- Modal footer -->
                <div class="modal-footer" style="border-top: 1px solid #dee2e6;"> 
                    <button type="button" class="btn btn-primary" id="createChatroom">생성</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 진짜 나가게? 물어보는 모달용 -->
<div class="modal" id="exitModal" >
    <div class="modal-dialog" style="width: 500px; ">
        <div class="modal-content" style="border: 1px solid #00000021;border-radius: 20px;box-shadow: 2px 4px 3px 3px darkgray;width: 500px; height:280px;">

            <!-- Modal Header -->
            <div class="modal-header" style="border-bottom: 1px solid #dee2e6;">
                <h4 class="modal-title">채팅방 나가기 알림</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body" style="display: flex; justify-content: space-evenly; font-size: 28px;color: black; text-align:center; height: auto;">
                <p style="font-size: 28px;color: black; margin:30px 0px; height: 40px !important;">
                채팅방을 나가시겠습니까?
            </p>
            </div>
            
            <!-- Modal footer -->
            <div class="modal-footer" style="border-top: 1px solid #dee2e6;">
                <button type="button" class="btn btn-primary" id="confirmExit">나가기</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script th:inline="javascript">

function closeErrorModal() {
			$('#exitModal').modal('hide');
	}

	$(document).ready(function() {
			// 검색 빈값 처리
			$('#deleteChatroomButton').on('click', function() {
					
					
							$('#exitModal').modal('show'); // 모달 표시
							return false;
					
			});
	});
    var profileImg = '<%=session.getAttribute("ProfileImg")%>';

// console.log('requestURL : ' + /*[[ ${#httpServletRequest.requestURL} ]]*/);
// console.log('requestURI : ' + /*[[ ${#httpServletRequest.requestURI} ]]*/);
// console.log('serverPort : ' + /*[[ ${#httpServletRequest.serverPort} ]]*/);
// console.log('serverName : ' + /*[[ ${#httpServletRequest.serverName} ]]*/);
// console.log('servletPath : ' + /*[[ ${#httpServletRequest.servletPath} ]]*/);
// console.log('remoteAddr : ' + /*[[ ${#httpServletRequest.remoteAddr} ]]*/);
// console.log('method : ' + /*[[ ${#httpServletRequest.method} ]]*/);
// console.log('requestedSessionId : ' + /*[[ ${#httpServletRequest.requestedSessionId} ]]*/);
// console.log('scheme : ' + /*[[ ${#httpServletRequest.scheme} ]]*/);
// console.log('protocol : ' + /*[[ ${#httpServletRequest.protocol} ]]*/);
// console.log('locale : ' + /*[[ ${#httpServletRequest.locale} ]]*/);
// console.log('secure : ' + /*[[ ${#httpServletRequest.secure} ]]*/);

// let uri = /*[[ ${#httpServletRequest.requestURI} ]]*/;
// let url = /*[[ ${#httpServletRequest.requestURL} ]]*/;
// let path = url.replace(uri, '');
// console.log('path 찍는 용도' + path)

//WebSocket 연결 설정
const alarmClient = new StompJs.Client({
brokerURL: 'ws://43.202.80.98:85/chatserver' // WebSocket 서버 URL
});

// 페이지 로드시 웹소켓 연결
window.addEventListener("load", function(event) {
   alarmClient.activate();
});

  // 연결 성공시
alarmClient.onConnect = (frame) => {
    console.log('Connected: ' + frame);
    // 프로젝트 구독     
	alarmClient.subscribe('/alarmMan/proAlm/' + '[[${session.Id}]]', (alarmMsg) => {
	    almSendMsg(JSON.parse(alarmMsg.body));
    });
    // 채팅방 생성 초대 구독
	alarmClient.subscribe('/alarmMan/chatAlm/' + '[[${session.Id}]]', (alarmMsg) => {
	    almSendMsgChat(JSON.parse(alarmMsg.body));
    });
    
 };

//에러
alarmClient.onWebSocketError = (error) => {
      console.error('Error with websocket', error);
};

alarmClient.onStompError = (frame) => {
      console.error('Broker reported error: ' + frame.headers['message']);
      console.error('Additional details: ' + frame.body);
};
function almSendMsg() {
	   toastAct()	
}
function almSendMsgChat() {
	   toastActChat()	
}

function toastAct() {
	  toastr.options.escapeHtml = true;
      toastr.options.closeButton = true;
      toastr.options.newestOnTop = false;
      toastr.options.progressBar = true;
      toastr.options.positionClass = 'toast-bottom-right'; // toast를 오른쪽 아래에 띄우도록 설정
      toastr.options.backgroundColor = '#35A880'; // 배경 색상을 #35A880로 설정
      toastr.options.textColor = '#FFFFFF'; // 글자 색상을 흰색(#FFFFFF)으로 설정
      toastr.info('새로운 프로젝트에 초대되었습니다.', '프로젝트 알림', {timeOut: 5000});
}

function toastActChat() {
	  toastr.options.escapeHtml = true;
      toastr.options.closeButton = true;
      toastr.options.newestOnTop = false;
      toastr.options.progressBar = true;
      toastr.options.positionClass = 'toast-bottom-right'; // toast를 오른쪽 아래에 띄우도록 설정
      toastr.options.backgroundColor = '#35A880'; // 배경 색상을 #35A880로 설정
      toastr.options.textColor = '#FFFFFF'; // 글자 색상을 흰색(#FFFFFF)으로 설정
      toastr.info('새로운 채팅방에 초대되었습니다.', '채팅방 알림', {timeOut: 5000});
}

let myName = /*[[${name}]]*/ 'name';
let senderName = /*[[${name}]]*/ 'name';
let realId = /*[[${id}]]*/ 'id';
let chatDTO = /*[[${chatDTO}]]*/ 'chatDTO';
var roomNo = /*[[${roomNo}]]*/ 'roomNo';
let chatMessageDTO = /*[[${chatDTO}]]*/ 'chatDTO';


// 페이지가 로드될 때 chatDTO 내용을 기반으로 채팅 내용을 화면에 추가
$(document).ready(function() {
    $('#memberList').on('click', function(){
        $('.tooltip-content').toggle();
        event.stopPropagation(); // 이벤트 버블링을 중지
    });
    
    // 페이지 어딘가를 클릭하면 툴팁이 사라지도록 설정
    $(document).on('click', function(){
        $('.tooltip-content').hide();
    });
    console.log(JSON.stringify(chatDTO) + "chatDTO 확인하렬로 하는거임")
    chatDTO.forEach(function(chat) {
        console.log(chat + "chat확인할려고 제발 ㅋㅋㅋㅋ")
    	//chatMessageDTO.forEach(function(chat) {
        if (chat.name == myName) {  // 추가된 코드
            chat.id = realId;
        }
        var imageUrl
        if (chat.uuid && chat.uploadPath && chat.fileName) {
            // 이미지 URL 생성
        imageUrl = chat.uploadPath ? '/display?fileName=' + encodeURIComponent(chat.uploadPath + '/s_' + chat.uuid + '_' + chat.fileName) : '';
        }
        //const LR = (chat.id != realId) ? "left" : "right";
        let LR; 
        if (chat.id === null || chat.id === '') {
        	LR = "middle";
        } else if (chat.id === realId) {
        	LR = "right";
        } else {
        	LR = "left";
        }
        console.log(imageUrl + "확인용확인용")
        appendMessageTag(LR, chat.name, chat.content, chat.msgTime, imageUrl);
    });
});


const stompClient = new StompJs.Client({
	//brokerURL : 'ws://43.202.80.98:85/chatserver'
	brokerURL : 'ws://localhost:8081/chatserver'
});


stompClient.activate();
console.log("Username: ", myName);  // 로그 추가
console.log("Room number: ", roomNo);  // 로그 추가
stompClient.onConnect = (frame) => {
  stompClient.subscribe('/topic/messages/' + roomNo, (messages) => {
        receive(JSON.parse(messages.body));
    });
};
stompClient.onWebSocketError = (error) => {
	console.error('Error with websocket', error);
};

stompClient.onStompError = (frame) => {
	console.error('Broker reported error : ' + frame.headers['message']);
	console.error('Additional details : ' + frame.body);
};
stompClient.onWebSocketClose = (event) => {
    console.error('Websocket closed', event);
};
//채팅방 나가기
const deleteButton = document.getElementById('confirmExit');
deleteButton.addEventListener('click', (event) => {
    event.preventDefault();
    fetch('/deleteChatroom', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ roomNo: roomNo, id: realId }),
    })
    .then(response => {
        if (response.ok) {
            console.log('Chatroom deleted successfully');
            //location.reload();
            window.close();
            window.opener.location.href="/roomList";
        } else {
            console.error('Failed to delete chatroom');
        }
    })
    .catch((error) => {
        console.error('Error:', error);
    });
});

$(document).on('keydown', 'div.input-div textarea', function(e) {
    if (e.keyCode == 13 && !e.shiftKey) {
        e.preventDefault();
        const message = $(this).val();
        sendAndClear(message);
    }
});

function createMessageTag(LR_className, senderName, message, msgTime, imageUrl) {
    let chatLi = $('div.chat.format ul li').clone();
    chatLi.addClass(LR_className);
    chatLi.find('.sender span').text(senderName);
    chatLi.find('.message span').text(message);
    chatLi.find('.message2 small').text(msgTime);
    console.log(imageUrl + "이거 확인해봐야함. 그래야 append들어감.")
    // 이미지가 있으면 그 이미지를 사용하고, 없으면 기본 이미지를 사용
    if (imageUrl !== null && imageUrl !== '') {
    console.log(imageUrl + "확인하려고 여기 놔두기 imageUrl1")
    chatLi.find('.sender .profile').css('background-image', 'url(' + imageUrl + ')');
    console.log(imageUrl + "확인하려고 여기 놔두기 imageUrl2")
} else {
    chatLi.find('.sender .profile').css('background-image', 'url(/img/userProf.png)');
}
    return chatLi;
}

function appendMessageTag(LR_className, senderName, message, msgTime, imageUrl) {
    var chatLi = createMessageTag(LR_className, senderName, message, msgTime, imageUrl);
    $('div.chat:not(.format) ul').append(chatLi);
    window.requestAnimationFrame(function () {
        const chatDiv = $('div.chat');
        chatDiv.scrollTop(chatDiv.prop('scrollHeight'));
    });
}

function clearTextarea() {
    $('div.input-div textarea').val('');
}

//  서버에서 들렸다가 온 메세지
function receive(data) {
    
	let LR;
	console.log(data.id + "data id 확인용");
	console.log(realId + "realId 확인용");
    if (data.id === null || realId === '') {
    	LR = "middle";
    } else if(data.id == realId) {
        LR = "right";
    } else {
    	LR = "left";
    }
    appendMessageTag(LR, data.name, data.content, data.msgTime);  // 서버에서 받은 시간 데이터를 사용합니다.
}

function sendAndClear(message) {
    if (message.trim() !== "") {
        sendMessage(message);
        clearTextarea();
        window.opener.location.reload();
    }
}
function getFullYmdStr() {
    var d = new Date();
    var year = String(d.getFullYear()).slice(-2); // 연도의 마지막 두 자리만 가져옴

    var month = d.getMonth() + 1; // 월은 0부터 시작하므로 1을 더함
    month = month < 10 ? '0' + month : month; // 월이 한 자리 수이면 앞에 '0'을 붙임

    var date = d.getDate();
    date = date < 10 ? '0' + date : date; // 일이 한 자리 수이면 앞에 '0'을 붙임

    var hour = d.getHours();
    hour = hour < 10 ? '0' + hour : hour; // 시간이 한 자리 수이면 앞에 '0'을 붙임

    var minute = d.getMinutes();
    minute = minute < 10 ? '0' + minute : minute; // 분이 한 자리 수이면 앞에 '0'을 붙임

    return year + "년 " + month + "월 " + date + "일 " + hour + "시 " + minute + "분 ";
}
//메세지 보낼 때
function sendMessage(message) {
	let currentTime = getFullYmdStr()
	
	console.log(currentTime + "커런트타임");
    stompClient.publish({
    	destination: "/app/chat/" + roomNo,
        body: JSON.stringify({
        	'roomNo': roomNo,
            'name': senderName,
            'content': message,
            'id' : realId,
            'msgTime' : currentTime 
        })
    });
}

$('#sendMessageBtn').on('click', function() {
    const message = $('div.input-div textarea').val();
    sendAndClear(message);
});

$(window).on('beforeunload', function(){
    disconnect();
});
function fetchEmployees(roomNo) {
    fetch('/empListExcludingRoomMembers/' + roomNo)
    .then(response => response.json())
    .then(employees => {
        const employeeListUl = document.getElementById('employeeList');
        // Clear the list before appending new items
        employeeListUl.innerHTML = '';
        employees.forEach(employee => {
            const li = document.createElement('li');
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'employee-' + employee.id;
            checkbox.value = employee.id;

            // const empNo = document.createElement('span');
            // empNo.textContent = employee.empNo + ' ';
            
            const empId = document.createElement('span');
            empId.textContent = employee.id + ' ';
            
            const empName = document.createElement('span');
            empName.textContent = employee.name + ' ';

            const empRank = document.createElement('span');
            empRank.textContent = employee.rank + ' ';

            const empDept = document.createElement('span');
            empDept.textContent = employee.deptName;



            label.appendChild(checkbox);
            // label.appendChild(empNo);
            label.appendChild(empId);
            label.appendChild(empName);
            label.appendChild(empRank);
            label.appendChild(empDept);
            
            li.appendChild(label);

            employeeListUl.appendChild(li);
        });
    })
    .catch((error) => {
        console.error('Error:', error);
    });
}

$('#inviteModal').on('shown.bs.modal', function (event) {
	console.log(roomNo);
    fetchEmployees(roomNo);
});

//채팅멤버 추가하는 로직
$('#createChatroom').on('click', function() {
    // Checked checkboxes
    const checkedEmployeeIds = [];
    $('#employeeList input[type="checkbox"]:checked').each(function () {
        checkedEmployeeIds.push($(this).val());
    });

    if (checkedEmployeeIds.length === 0) {
        alert('Please select at least one employee to invite.');
        return;
    }
	
    // Post request to the server
    const roomDTO = {
        roomNo: roomNo,
        employeeIds: checkedEmployeeIds,
    };
    fetch('/inviteEmployees', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(roomDTO),
    })
    .then(response => {
        console.log(response)
    	if (response.ok) {
            console.log(response.ok)
    		console.log('Employees invited successfully');
            // Here you might want to do something to reflect that the employees were added
            // For example, you could close the modal
            $('#inviteModal').modal('hide');
            location.reload();
            
            // 알림2
            for(let i = 0; i < checkedEmployeeIds.length ; i++){
				alarmClient.publish({
		            destination: "/alarmCondition/chatAlm/"+checkedEmployeeIds[i],
		            body: JSON.stringify({
		               'id' : checkedEmployeeIds[i]
		            })
		      	});
			}
        } else {
            console.error('Failed to invite employees');
        }
    })
    .catch((error) => {
        console.error('Error:', error);
    });
});
</script>
</body>
</html>