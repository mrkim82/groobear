<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<title>Groobear</title>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link
	href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900"
	rel="stylesheet">

<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"> -->
<link rel="stylesheet" href="/bootstrap.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">
<style>
#modalFolderCreate1, #modalFolderCreate2, #modalFolderCreate3 {
	position: fixed; /* Stay in place */
	z-index: 1; /* Sit on top */
	padding-top: 100px; /* Location of the box */
	left: 0;
	top: 0;
	width: 100%; /* Full width */
	height: 100%; /* Full height */
	overflow: auto; /* Enable scroll if needed */
	background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
	display: none;
}

.horizontal-bar {
	height: 80px;
	width: 100%;
	background-color: rgb(104, 192, 86);
}

.horizontal-bar2 {
	height: 40px;
	width: 100%;
	background-color: rgb(50, 100, 86);
}

#modalFolderCreate4 {
	position: fixed; /* Stay in place */
	z-index: 1; /* Sit on top */
	padding-top: 100px; /* Location of the box */
	left: 0;
	top: 0;
	width: 100%; /* Full width */
	height: 100%; /* Full height */
	overflow: auto; /* Enable scroll if needed */
	background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
	display: none;
}

#modalBody, #modalBody2, #modalBody3 {
	width: 500px;
	height: 300px;
	padding: 30px 30px;
	margin: 0 auto;
	border: 1px solid #777;
	background-color: #fff;
}

#closeBtn, #closeBtn2 {
	float: right;
	font-weight: bold;
	color: #777;
	font-size: 25px;
	cursor: pointer;
}

details {
	padding: 12px;
	text-decoration: none;
	font-size: 16px;
	color: #bdc3c7;
	display: flex;
	align-items: center;
	transition: 0.3s;
}

.square {
	width: 50px;
	height: 50px;
	background-color: #000;
	margin-left: 30px;
}
</style>
</head>
<body>
	<div>

		<!-- 상단 header -->
		<header class="blog-header lh-1 py-3">
			<div
				class="row flex-nowrap justify-content-between align-items-center">
				<div class="col-4 pt-1">
					<img src="" title="" style="width: 200px;">
				</div>

				<div class="col-4 text-center">
					<a class="blog-header-logo text-body-emphasis" href="#">Groobear</a>
				</div>
				<div class="col-6 d-flex justify-content-end align-items-center"
					style="margin-left: -200px; font-family: 'Hahmlet', serif;">
					<table style="width: 300px;">
						<tbody>
							<tr>
								<td><a>[[${session.Name }]]님 반갑습니다</a></td>
							</tr>
							<tr>
								<td><span><a href="/logout">로그아웃</a></span>&nbsp;&nbsp;&nbsp;&nbsp;
									<span><a href="#">마이페이지</a></span></td>

							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</header>
	</div>

	<!-- 상단 nav -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
		<button class="navbar-toggler" type="button" data-toggle="collapse"
			data-target="#navbarColor01" aria-controls="navbarColor01"
			aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarColor01">

			<ul class="navbar-nav mr-auto">
				<li class="nav-item active"><a class="nav-link" href="#">Home
						<span class="sr-only">(current)</span>
				</a></li>
				<li class="nav-item"><a class="nav-link" href="#">Features</a>
				</li>
				<li class="nav-item"><a class="nav-link" href="#">Pricing</a></li>
				<li class="nav-item"><a class="nav-link" href="#">About</a></li>
				<li class="nav-item dropdown"><a
					class="nav-link dropdown-toggle" data-toggle="dropdown" href="#"
					role="button" aria-haspopup="true" aria-expanded="false">Dropdown</a>
					<div class="dropdown-menu">
						<a class="dropdown-item" href="#">Action</a> <a
							class="dropdown-item" href="#">Another action</a> <a
							class="dropdown-item" href="#">Something else here</a>
						<div class="dropdown-divider"></div>
						<a class="dropdown-item" href="#">Separated link</a>
					</div></li>
				<li><a th:text="${session.UserId}"></a></li>
			</ul>
		</div>
	</nav>

	<!-- 사이드바 -->

	<div class="container-fluid" style="padding: 0;">
		<div class="float-start">
			<div class="sidebar" style="padding: 0;">
				<!-- 사이드바 내용 -->
				<table>
					<tbody>
						<tr>
							<td style="vertical-align: top">
								<div class="row">
									<div class="sidebar col-4">
										<a href="/proCreate"><span class="material-icons">add_box</span>
											새 프로젝트 생성</a> <a href="/proMain"><span class="material-icons">home</span>
											내 프로젝트</a> <a href="/proMainS"><span class="material-icons">star</span>
											즐겨찾기</a> <a href="#"><span class="material-icons">mail</span>
											미확인(x)</a> <a href="/proMainG"><span class="material-icons">drafts</span>
											미분류</a> <a href="/proMainH"><span class="material-icons">visibility_off</span>
											숨김</a>
										<details>
											<summary>모아보기</summary>
											<ul>
												<li>전체업무</li>
												<li>북마크</li>
												<li>나를 언급</li>
												<li>내 게시물</li>
											</ul>
										</details>
										<details id="groupFolderList" open>
											<summary>
												프로젝트 폴더<span id="popupProjectBtn" class="material-icons">add</span>
											</summary>
											<!-- 프로젝트 그룹 리스트 -->
											<ul id="proGroup">
												<th:block th:each="proG : ${projectGroupList}">
													<li><a
														th:attr="data-gN=${proG.groupNo}, data-fName=${proG.groupName}"
														th:href="@{/proGroupD/{groupNo}(groupNo=${proG.groupNo})}">
															[[${proG.groupName}]]<span
															class='material-icons moreVertIcons'
															style='display: none;'>more_vert</span>
													</a></li>
												</th:block>
											</ul>
										</details>

									</div>



								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>


		<!-- 프로젝트 우측 컨텐츠 -->
		<div class="float-start" style="width: 1000px;">
			<!-- 프로젝트 최 상단 바 -->
			<div class="horizontal-bar">
				<div>
					<ul class="nav">
						<li><th:block th:each="color : ${projectTopBar}">
								<!-- 스타일을 동적으로 적용하는 네모 -->
								<div class="square"
									th:style="'background-color: ' + ${color.proColor}"></div>
							</th:block></li>
						<li class="nav-item"><span class='material-icons'
							style="cursor: pointer;">more_vert</span></li>
						<li class="nav-item" th:text="${projectTopBar[0].proName}"></li>
						<li class="nav-item" th:text="${projectTopBar[0].proContent}"
							th:style="'margin-left:30px;'"></li>
					</ul>
				</div>
			</div>
			<!-- 프로젝트 탭 -->
			<div class="horizontal-bar2">
				<ul class="nav nav-tabs">
						<th:block th:each="hometab, status : ${projectTopBar}">
							<li class="nav-item"><a class="nav-link"
								th:attr="aria-current=${hometab == 1 ? 'page' : null}"> 업무 </a></li>

							<li class="nav-item"><a class="nav-link"
								th:attr="aria-current=${hometab == 2 ? 'page' : null}"> 피드 </a></li>

							<li class="nav-item"><a class="nav-link"
								th:attr="aria-current=${hometab == 3 ? 'page' : null}"> 간트차트 </a></li>

							<li class="nav-item"><a class="nav-link"
								th:attr="aria-current=${hometab == 4 ? 'page' : null}"> 캘린더 </a></li>

							<li class="nav-item"><a class="nav-link"
								th:attr="aria-current=${hometab == 5 ? 'page' : null}"> 파일 </a></li>

							<li class="nav-item"><a class="nav-link"
								th:attr="aria-current=${hometab == 6 ? 'page' : null}"> 알림 </a></li>
							<li th:text="${projectUserCount} + 명"></li>
					</th:block>
				</ul>
			</div>
			<div>
				<div layout:fragment="content"></div>
			</div>
		</div>



	</div>


	<div>



		<!-- modal창 -->
		<div id="modalFolderCreate1">
			<div id="modalContent">
				<div id="modalBody">
					<span id="closeBtn">&times;</span>
					<p>프로젝트 폴더 만들기</p>
					<input type="text" placeholder="프로젝트 폴더명을 입력하세요"
						id="folderContent1">
					<button type="button" id="cancelBtn" class="btn btn-primary">취소</button>
					<button type="button" id="createFolder">확인</button>
				</div>
			</div>
		</div>
		<!-- modal창2 -->
		<div id="modalFolderCreate2">
			<div id="modalContent2">
				<div id="modalBody2">
					<span id="closeBtn2">&times;</span>
					<p>프로젝트 폴더명 수정하기</p>
					<input type="text" placeholder="프로젝트 폴더명을 입력하세요"
						id="folderContent2">
					<button type="button" id="cancelBtn2" class="btn btn-primary">취소</button>
					<button type="button" id="updateFolderName">변경</button>
				</div>
			</div>
		</div>
		<!-- modal창3 -->
		<div id="modalFolderCreate3">
			<div id="modalContent3">
				<div id="modalBody3">
					<p>프로젝트 폴더를 삭제하시겠습니까?</p>
					<p>프로젝트 폴더에 포함된 프로젝트는 삭제되지 않습니다.</p>
					<button type="button" id="cancelBtn3" class="btn btn-primary">취소</button>
					<button type="button" id="deleteFolder">확인</button>
				</div>
			</div>
		</div>


	</div>





	<script th:inline="javascript">
    /*<![CDATA[*/
		//그룹 갯수 체크
    	let pGC = /*[[${projectGroupList}]]*/ [];
    	let pGCUp = pGC.length;
    	
    	//변수선언
	    let modal1 = document.getElementById('modalFolderCreate1');
	    let modal2 = document.getElementById('modalFolderCreate2');
	    let modal3 = document.getElementById('modalFolderCreate3');
	    let closeBtn1 = document.getElementById('closeBtn');
	    let closeBtn2 = document.getElementById('closeBtn2');
	    let cancelBtn1 = document.getElementById('cancelBtn');
	    let cancelBtn2 = document.getElementById('cancelBtn2');
	    let cancelBtn3 = document.getElementById('cancelBtn3');
		let folderC1 = document.getElementById('folderContent1');
		let folderC2 = document.getElementById('folderContent2');
		//변수선언2
	    let popupBtn = document.getElementById('popupProjectBtn');
		let creFolder = document.getElementById('createFolder');
		let uFolderName = document.getElementById('updateFolderName');
		let dFolder = document.getElementById('deleteFolder');
		
		//취소 공통
		let modals = [modal1, modal2];
		let closeBtns = [closeBtn1, closeBtn2];
		let cancelBtns = [cancelBtn1, cancelBtn2];
		let folderInputs = [folderC1, folderC2];

		//그룹 생성 모달창 띄우기
		popupBtn.addEventListener("click",function(e) { 
		  e.preventDefault();
		  modal1.style.display = 'block';
		});

		for (let i = 0; i < modals.length; i++) {
		  let modal = modals[i];
		  let closeBtn = closeBtns[i];
		  let cancelBtn = cancelBtns[i];
		  let folderInput = folderInputs[i];

		  closeBtn.addEventListener('click', function() {
		    closeModal(modal, folderInput);
		  });

		  cancelBtn.addEventListener('click', function() {
		    closeModal(modal, folderInput);
		  });
		  
		  window.addEventListener('keydown', function(e) {
			if(event.keyCode == 27){
				closeModal(modal, folderInput);
				modal3.style.display = "none";
				
				//modal4처리
				let dgm = document.querySelector('[data-group-modal]');
				let dgmC = dgm != null ? dgm.remove() : dgm; 
				
			}
		  });

		  window.addEventListener('click', function(event) {
		      let dgm = document.querySelector('[data-group-modal]');
		      let dgmC = document.querySelectorAll('[data-group-modal]');
		      let moreVert = event.target.parentElement.getElementsByClassName('moreVertIcons')[0];
		      
		    if (event.target === modal) {
		        closeModal(modal, folderInput);
		    } else if (event.target === moreVert && dgmC.length == 2) {
		    	dgm.remove()
		    } else if (event.target !== moreVert && dgmC.length == 1) {
		    	dgm.remove()
		    }
		    
		  });
		  
		}

		function closeModal(modal, input) {
		  modal.style.display = 'none';
		  input.value = '';
		}
		
		
		//시작
		
	    //클릭 후 그룹 폴더 만들기(모달1)
	    creFolder.onclick = function() {
	    	if(pGCUp >= 10) {
	    		alert('프로젝트 폴더는 최대 10개 생성 할 수 있습니다.');
	    		folderC1.value = '';
	    		modal1.style.display = "none";
	    	} else {
	    		//폴더명 확인
				checkGroupFolderName();
	    	}
				
		}
	    
	    //폴더명 확인
	    function checkGroupFolderName() {
			let formData = new FormData();
			formData.append('gN', folderC1.value);
			
			if(folderC1.value == '') {
	    		alert('폴더 이름은 공백을 허용하지 않습니다!');
	    		return;
	    	} else if (folderC1.value.length > 30) {
	    		alert('폴더 이름은 최대 30자 까지 가능합니다!');
	    		return;
	    	} else {
	    		//db정보 삽입
				fetch("/proGroupC", {
					method: 'POST',
					body : formData
				})
				.then(response => response.json())
				.then(res => {
					let rC = res.result;
					let latelyGroupNum = res.pGN;
					if(rC == '성공') {
						//동적 폴더 생성
						createFolder(latelyGroupNum);				
					} else {
						alert('요청이 취소 되었습니다.');
					}
				});
	    	};
			
	    };
	    
	    //동적 폴더 생성
	    function createFolder(lGN) {
				let pG = document.getElementById('proGroup');
	    		let liC = document.createElement('li');
				let aC = document.createElement('a');
				let spanC = document.createElement('span');

				spanC.className = 'material-icons moreVertIcons';
				spanC.style = 'display : none;';
				spanC.textContent = 'more_vert';
				
				aC.setAttribute('href', 'proGroupD/'+ lGN);
				aC.setAttribute('data-gN', lGN);
				aC.setAttribute('data-fName', folderC1.value);
				aC.textContent = folderC1.value;
				
				aC.append(spanC);
				liC.append(aC);
				pG.prepend(liC);
				
				folderC1.value = '';
				modal1.style.display = 'none';
				
				pGCUp++;
	    };
	    
	    // 프로젝트 그룹 상태 등장 효과
		let groupFolderUL = document.querySelector('#groupFolderList>ul');
		
		groupFolderUL.addEventListener("mouseover", makeGroupStatus);
		groupFolderUL.addEventListener("mouseout", deleteGroupStatus);
		
		//상태 등장
		function makeGroupStatus() {
			if(event.target.tagName == "A") {
				event.target.childNodes[1].style.display = 'block';
			} else if (event.target.tagName == "SPAN") {
				event.target.style.display = 'block';
			}
		};
		
		//상태 숨김
		function deleteGroupStatus() {
			if(event.target.tagName == "A") {
				event.target.childNodes[1].style.display = 'none';
			} else if (event.target.tagName == "SPAN") {
				event.target.style.display = 'none';
			}
		};
		
		//프로젝트 그룹 상태 클릭 속성(모달4)
		groupFolderUL.addEventListener("click", groupStatusModal);
		
		function groupStatusModal(event) {
			
			if(event.target.tagName == "SPAN") {
				event.preventDefault();
				
				//그룹no값 가져오기
				let groupNo = event.target.parentNode.dataset.gn;
				let groupName = event.target.parentNode.dataset.fname;
				
				//그룹 모달창 생성(모달4)
				miniModal(event.target);
				
				let groupNameChange = document.getElementById('groupNameChange' + groupNo);
				let groupDelte = document.getElementById('groupDelte' + groupNo);
				
				//프로젝트 수정창 띄우기(모달2)
				groupNameChange.addEventListener("click", function(e) {
					e.preventDefault();
					
					//인풋상자 값 넣어주기
					folderC2.value = groupName;
					//상태 모달창 삭제
					document.querySelector('[data-group-modal]').remove();
					
					modal2.style.display = 'block';
					
					//디비 수정
					uFolderName.addEventListener('click', function() {
						groupNameChangeDb(groupNo);
					});
					
			    });
				
				//프로젝트 삭제창(모달3)
				groupDelte.addEventListener("click", function(e) {
					e.preventDefault();
					//상태 모달창 삭제
					document.querySelector('[data-group-modal]').remove();
					
					modal3.style.display = 'block';
					
					window.onclick = function(event) {
				      if (event.target == modal3) {
				        modal3.style.display = "none";
				      }
				    }
					
					cancelBtn3.onclick = function() {
				      modal3.style.display = 'none';
				    }
					
					dFolder.addEventListener("click", function() {
						
						fetch("/FolderGroupD/" + groupNo, {
							method: 'DELETE'
						})
						.then(response => response.json())
						.then(res => {
							let rC = res.result;
						
							if(rC == '성공') {
								document.querySelectorAll(`[data-gN="${groupNo}"]`)[0].parentNode.remove();
								modal3.style.display = 'none';
							} else {
								alert('요청이 취소 되었습니다.');
							}
						});
					});
					
			    });
				
			}
		};
		
		
		//그룹명 디비 수정
		function groupNameChangeDb(groupNo) {
			if(folderC2.value == '') {
	    		alert('폴더 이름은 공백을 허용하지 않습니다!');
	    		return;
	    	} else if (folderC2.value.length > 30) {
	    		alert('폴더 이름은 최대 30자 까지 가능합니다!');
	    		return;
	    	} else {
	    		console.log('gn몇개 드가?'+groupNo);
	    		fetch("/proGroupNameC", {
    			  method: 'PUT',
    			  headers: {
    			    'Content-Type': 'application/json'
    			  },
    			  body: JSON.stringify({
    				    groupName: folderC2.value,
    				    groupNo: groupNo
    				  })
    			})
				.then(response => response.json())
				.then(res => {
					let rC = res.result;
				
					if(rC == '성공') {
						modal2.style.display = 'none';
						document.querySelectorAll(`[data-gN="${groupNo}"]`)[0].childNodes[0].textContent = folderC2.value;
					} else {
						alert('요청이 취소 되었습니다.');
					}
				});
	    	};
		};
		
		
		//그룹 모달창 생성
		function miniModal(target) {
			// 선택한 요소
			let targetElement = target.parentNode;
			let groupNum = targetElement.dataset.gn;

			// 모달 창 생성
			let modal4 = document.createElement('div');
			modal4.dataset.groupModal = groupNum;
			modal4.style.maxWidth = '100%';
			modal4.style.width = '68px';
			modal4.style.height = '58px';
			modal4.style.backgroundColor = 'lightgray';
			modal4.style.padding = '10px';
			modal4.style.position = 'absolute';
			modal4.style.top = targetElement.offsetTop + targetElement.offsetHeight + 68 + 'px';
			modal4.style.left = (targetElement.offsetLeft + 190) + 'px';
			modal4.style.marginTop = '4px';
			modal4.style.display = 'flex';
			modal4.style.flexDirection = 'column';
			modal4.style.alignItems = 'center';
			modal4.style.justifyContent = 'center';
			modal4.style.zIndex = '9999';

			// 버튼 추가
			let button1 = document.createElement('button');
			button1.type = 'button';
			button1.id = 'groupNameChange' + groupNum;
			button1.style.backgroundColor = 'transparent';
			button1.style.border = 'none';
			button1.style.display = '-webkit-box';
			button1.style.webkitLineClamp = '2';
			button1.style.webkitBoxOrient = 'vertical';
			button1.style.overflow = 'hidden';
			button1.style.textOverflow = 'ellipsis';
			button1.style.maxHeight = '2.8em';
			button1.style.lineHeight = '1.4em';
			button1.style.fontSize = '12px';
			
			// 버튼 내용 추가
			let content1 = document.createTextNode('수정');
			button1.appendChild(content1);
			
			// 버튼 생성
			let button2 = document.createElement('button');
			button2.type = 'button';
			button2.id = 'groupDelte' + groupNum;
			button2.style.backgroundColor = 'transparent';
			button2.style.border = 'none';
			button2.style.display = '-webkit-box';
			button2.style.webkitLineClamp = '2';
			button2.style.webkitBoxOrient = 'vertical';
			button2.style.overflow = 'hidden';
			button2.style.textOverflow = 'ellipsis';
			button2.style.maxHeight = '2.8em';
			button2.style.lineHeight = '1.4em';
			button2.style.fontSize = '12px';
			
			// 버튼 내용 추가
			let content2 = document.createTextNode('삭제');
			button2.appendChild(content2);

			// 버튼을 모달 창에 추가
			modal4.appendChild(button1);
			modal4.appendChild(button2);
			
			document.body.appendChild(modal4);
		}
		
    /*]]>*/
    </script>
</body>
</html>