<!DOCTYPE html>
<html>
<head>
    <title>Chat List</title>
	<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>	
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <style>
    #chatlist {
    width: 300px;
    list-style-type: none;
    padding: 0;
    font-family: Arial, sans-serif;
}

.chatroom {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
    cursor: pointer;
}

.chatroom:hover {
    background-color: #eee;
}

.profile-pic {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 10px;
}

.chatroom-name {
    font-weight: bold;
    margin-bottom: 5px;
}

.chatroom-info {
    flex-grow: 1;
}

.new-message-notification {
    background-color: #ff0000;
    color: #ffffff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    text-align: center;
    line-height: 20px;
    font-size: 14px;
    margin-left: 10px;
}

#addChatroom {
    font-size: 24px;
    background: none;
    border: none;
}
    </style>
</head>
<body>
    <h1>채팅방목록</h1>
    <button id="addChatroom" data-toggle="modal" data-target="#myModal">+</button>
    <ul id="chatlist">
        <!-- Chat rooms will be added here dynamically -->
    </ul>

    <!-- The Modal -->
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">새 채팅방 만들기</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <input type="text" id="chatroomName" placeholder="채팅방 이름">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="createChatroom">생성</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <script>
    
    
        function createChatroomElement(chatroom) {
        	console.log("넘어와")
            const li = document.createElement('li');
            li.classList.add('chatroom');

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent the li click event from triggering
                stompClient.send("/app/deleteChatroom", {}, JSON.stringify(chatroom));
            });

            li.appendChild(deleteButton);
            
            const img = document.createElement('img');
            img.src = chatroom.profilePic;
            img.alt = 'Profile picture';
            img.classList.add('profile-pic');

            const infoDiv = document.createElement('div');
            infoDiv.classList.add('chatroom-info');
            const name = document.createElement('div');
            name.textContent = chatroom.name;
            name.classList.add('chatroom-name');
            const lastMessage = document.createElement('div');
            lastMessage.textContent = chatroom.lastMessage;
            infoDiv.appendChild(name);
            infoDiv.appendChild(lastMessage);

            const notification = document.createElement('div');
            if (chatroom.newMessages > 0) {
                notification.textContent = chatroom.newMessages;
                notification.classList.add('new-message-notification');
            }

            li.appendChild(img);
            li.appendChild(infoDiv);
            li.appendChild(notification);

            li.addEventListener('click', () => {
                alert(`You have selected ${chatroom.name}`);
            });

            return li;
        }

        const chatlist = document.getElementById('chatlist');

        /* socket = new SockJS('/chatserver');
        const stompClient = Stomp.over(socket); */
        const stompClient = new StompJs.Client({
        	brokerURL : 'ws://localhost:8081/chatserver'
        })
        stompClient.activate();
        stompClient.onConnect(function(frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/chatrooms' , function(chatrooms) {
                const parsedChatrooms = JSON.parse(chatrooms.body);
                chatlist.innerHTML = '';
                parsedChatrooms.forEach(chatroom => {
                    const chatroomElement = createChatroomElement(chatroom);
                    chatlist.appendChild(chatroomElement);
                });
            });
            
        });

        document.getElementById('createChatroom').addEventListener('click', () => {
            const chatroomName = document.getElementById('chatroomName').value;
            if (chatroomName) {
                const newChatroom = {
                    roomName: chatroomName, 
                    lastMessage: 'No messages yet', 
                    newMessages: 0, 
                    profilePic: 'placeholder.jpg' 
                };
                fetch('/newChatroom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newChatroom),
                })
                .then(response => response.json())
                .then(createdRoom => {
                	console.log(createdRoom)
                    const chatroomElement = createChatroomElement(createdRoom);
                    chatlist.appendChild(chatroomElement);
                    $('#myModal').modal('hide');
                    document.getElementById('chatroomName').value = '';
                    
                    
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }
        });
        fetch("/roomGetList")
        .then(response => response.json())
        .then(result => {
        	console.log(result);
        })
        
    </script>
</body>
</html>